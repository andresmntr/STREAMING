<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Streaming</title>
    <link rel="stylesheet" type="text/css" href="index.css">
    <link rel="shortcut icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/Roundel_of_Spain.svg/1200px-Roundel_of_Spain.svg.png">
</head>
  <body>
    <h2>STREAMING</h2>
    <div class="container">
      <video class="dashjs-player" autoplay controls preload="auto">
      </video>    
      <div class="video-info">
        <p>Video Bitrate: </br>
          <span id="bitrate" class="info"></span>
        </p>
        <p>Video Buffer: </br>
          <span id="buffer" class="info"></span>
        </p>
        <p>Video Representation: </br>
          <span id="representation" class="info">hola</span>
        </p>
      </div>
    </div>
    <span id="stats"></span>
    <script src="http://cdn.dashjs.org/latest/dash.all.min.js"></script>
  </body>
  <footer>
    <h6>Andrés Montero Ranc</h6>
    <h6>Juan Lluva Llord</h6>
    <h6>Pablo Lostao Fernández</h6>
    <h6>Martín Collado</h6>
  </footer>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        init();
    });

    function init() {
        const protData = {
          'org.w3.clearkey': {
            clearkeys: {
              oW5AK5BW43HzbTSKpiu3SQ: 'hyN9IKGfWKdAwFaE5pm0qg'
            }
          }
        };

        let video,
            player,
            mpd_url = "./output2/stream.mpd"
            player = dashjs.MediaPlayerFactory.create(document.querySelector(".dashjsplayer"));

        video = document.querySelector("video");
        player = dashjs.MediaPlayer().create();
        player.initialize(video, mpd_url, true);
        player.on(dashjs.MediaPlayer.events["PLAYBACK_ENDED"], function () {
            clearInterval(eventPoller);
        });

        var eventPoller = setInterval(function () { 
            var streamInfo = player.getActiveStream().getStreamInfo(); 
            var dashMetrics = player.getDashMetrics(); 
            var dashAdapter = player.getDashAdapter();
        
            if (dashMetrics && streamInfo) { 
                const periodIdx = streamInfo.index; 
                var repSwitch = dashMetrics.getCurrentRepresentationSwitch('video', true); 
                var bufferLevel = dashMetrics.getCurrentBufferLevel('video', true); 
                var bitrate = repSwitch ? Math.round(dashAdapter.getBandwidthForRepresentation(repSwitch.to, periodIdx) / 1000) : NaN; 
                document.getElementById('buffer').innerText = bufferLevel + " secs"; 
                document.getElementById('bitrate').innerText = bitrate + " Kbps"; 
                document.getElementById('representation').innerText = repSwitch.to; 
            } 
        }, 500);
    };
</script>
</html>